---
import type { ImageMetadata } from "astro";
import { Image, getImage } from "astro:assets";
import Layout from "../layouts/Layout.astro";
import Spacer from "../components/Spacer.astro";
import Carousel from "../components/Carousel.astro";
import CarouselItem from "../components/CarouselItem.astro";
import WorksContainer from "../components/works/WorksContainer.svelte";
// import DraggableWindow from "../components/DraggableWindow.astro";
// import Logo3d from "../components/Logo3d.svelte";
import MusicPlayer from "../components/music/MusicPlayer.svelte";
import { queryAssets, getWorkId, getThumbnailSource } from "../utils";
import type { ImageAsset, Work, ImageSource } from "../types";
import { WORKS } from "../data";

const CAROUSEL_IMAGE_LIMIT = 20;

const carouselImages = queryAssets({
  type: "image",
  excludeHideFromCarousel: true,
}) as ImageAsset[];

// サムネイル画像 の最適化（一列時最大: 426.000 * 239.633）
const THUMBNAIL_WIDTH = 586;  // 426.000 * 1.375 = 585.750000
const THUMBNAIL_HEIGHT = 330; // 239.633 * 1.375 = 329.495375

// カルーセル画像の最適化 (13-inch iPad Pro M4: 45vh ≈ 412px)
const CAROUSEL_HEIGHT = 618; // 412 * 1.5 = 618

function isImageMetadata(src: ImageSource): src is ImageMetadata {
  return (
    typeof src !== "string" && "src" in src && "width" in src && "height" in src
  );
}

// 全Workからサムネイル画像を収集し、最適化済みURLを生成
const allWorks: Work[] = Object.values(WORKS).flat();
const thumbnailUrlMap: Record<string, string> = {};

for (const work of allWorks) {
  const workId = getWorkId(work);
  const imageSrc = getThumbnailSource(work);

  // ImageMetadataの場合のみ最適化
  if (imageSrc !== null && isImageMetadata(imageSrc)) {
    try {
      const optimized = await getImage({
        src: imageSrc,
        width: THUMBNAIL_WIDTH,
        height: THUMBNAIL_HEIGHT,
        // 範囲を完全に埋めるように拡大縮小し、トリミングまで行う
        fit: "cover",
        format: "webp",
      });
      thumbnailUrlMap[workId] = optimized.src;
    } catch {
      // 最適化に失敗した場合は元の画像を使用
      thumbnailUrlMap[workId] = imageSrc.src;
    }
  }
}

// // ウィンドウの最大サイズ。ビューポートが狭くなっても、このアスペクト比を保ちながら縮小する。
// const DRAGGABLE_WINDOW_MAX_SIZE = { width: 500, height: 276 };
// // 幅 (vw) に対するウィンドウの最大比率 (0 < n <= 1)
// const DRAGGABLE_WINDOW_SCALE = 0.85;
//
// const DRAGGABLE_WINDOW_ASPECT_RATIO =
//   DRAGGABLE_WINDOW_MAX_SIZE.height / DRAGGABLE_WINDOW_MAX_SIZE.width;
// const DRAGGABLE_WINDOW_WIDTH = `min(${DRAGGABLE_WINDOW_SCALE * 100}vw, ${DRAGGABLE_WINDOW_MAX_SIZE.width}px)`;
// const DRAGGABLE_WINDOW_HEIGHT = `min(calc(${DRAGGABLE_WINDOW_SCALE * 100}vw * ${DRAGGABLE_WINDOW_ASPECT_RATIO}), ${DRAGGABLE_WINDOW_MAX_SIZE.height}px)`;
---

<Layout title="WORKS">
  <Spacer height="1.3rem" />

  <Carousel
    slideHeight={{ desktop: "45vh", tablet: "30vh", mobile: "22vh" }}
    maxWidth="100vw"
    slideSpacing={{ desktop: "1rem", tablet: "0.7rem", mobile: "0.5rem" }}
    random
    limit={CAROUSEL_IMAGE_LIMIT}
  >
    {
      await Promise.all(
        carouselImages.map(async (asset) => {
          if (typeof asset.src === "string") {
            return (
              <CarouselItem>
                <Image src={asset.src} alt={asset.caption} inferSize />
              </CarouselItem>
            );
          }
          // ImageMetadataの場合は最適化
          const optimized = await getImage({
            src: asset.src,
            height: CAROUSEL_HEIGHT,
            format: "webp",
          });
          return (
            <CarouselItem>
              <img
                src={optimized.src}
                alt={asset.caption}
                width={optimized.attributes.width}
                height={optimized.attributes.height}
                loading="lazy"
                decoding="async"
              />
            </CarouselItem>
          );
        }),
      )
    }
  </Carousel>

  <Spacer height="1rem" />

  <h1>Our Works</h1>

  <WorksContainer client:load {thumbnailUrlMap} />

  <!-- <DraggableWindow
    title="REVATI Studio"
    width={DRAGGABLE_WINDOW_WIDTH}
    height={DRAGGABLE_WINDOW_HEIGHT}
  >
    <Logo3d client:only="svelte" />
  </DraggableWindow> -->

  <MusicPlayer client:load />
</Layout>

<style lang="scss">
  h1,
  h2,
  h3 {
    text-align: center;
  }

  h1 {
    font-size: 40px;
    @include font-montserrat(800);
  }

  body {
    overflow-x: hidden;
  }
</style>
